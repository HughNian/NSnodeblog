<%- include header.html %>
<% if(is_login){ %>
<div class="picside"></div>
<div class="userlist"></div>
<div class="sendbox">
  <div class="boxtop">
    <span class="chatname"></span>
    <span class="gb" hidefocus="true" style="cursor:pointer;">x</span>
    <span class="zxh" hidefocus="true" style="cursor:pointer;">-</span>
  </div>
  <article class="sendlist" id="sendlist"></article>
  <div class="bar"></div>
  <div class="sendarea">
  <textarea class="area" node-type="_editorNode"></textarea>
  </div>
  <div class="buttonarea">
   <a href="#nogo" class="sendbutton"></a>
  </div>
</div>
<div class="chatbox">
</div>
<% } %>
<body class="index-page" youdao="bind">
<header id="header" class="big-bg" style="height: 450px; background-position: 50% 0px;">
  <div class="header-inner" style="margin-top: 0px; opacity: 1;">
    <h1 id="title"> <a href="/"> <font style="color:#000000;font-family: 'Flamenco', cursive;font-size:65;">Love Life</font> </a> </h1>
  </div>
  <h1 id="title-small" style="opacity: 0;"><a href="/images/TAKE360精品生活.htm">爱生活</a></h1>
  <div id="header-pagination">
    <p><a class="top" href="http://wefriends001.diandian.com/#">返回顶部</a></p>
  </div>
</header>
<!-- close HEADER -->
<div id="wrapper" class="clearfix">
  <section id="content" style="padding-top: 510px;"> 
    
    <!--audio-->
    <article class="type-audio not-page clearfix 8721aca0-b225-11e0-9eb1-782bcb3825eb">
      <div class="post not-page">
        <div class="listen clearfix">
          <div class="song-info">
            <div class="player">
              <object width="257" height="33" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,28,0" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000">
                <param value="http://www.xiami.com/widget/0_1769628993/singlePlayer.swf" name="movie">
                <param value="transparent" name="wmode">
                <param value="high" name="quality">
                <embed width="257" height="33" type="application/x-shockwave-flash" pluginspage="http://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash" quality="high" wmode="transparent" menu="false" src="http://www.xiami.com/widget/0_1769628993/singlePlayer.swf">
              </object>
            </div>
            <h1>City of Twilight</h1>
            <h2>Raujika</h2>
            <h3>Fairy tale</h3>
            <div class="rich-content">
              <p class="plays"></p>
              <p>细细感受</p>
              <p></p>
            </div>
          </div>
          <div class="album-art"> <img class="AlbumArt" src="/images/3570241259547704.jpg"> </div>
        </div>
      </div>
      <!-- close POST -->
      <aside>
        <p class="meta"> <a href="http://wefriends001.diandian.com/post/2011-07-20/3040867">Jul 20, 2011</a><br>
          <a href="http://wefriends001.diandian.com/post/2011-07-20/3040867#notes">0&nbsp;°C</a><br>
        </p>
      </aside>
      <footer>
        <div class="footer-meta">
         
        </div>
        <!-- close FOOTER-META --> 
      </footer>
    </article>
    
    <!--photo-->
    <article class="type-photoset not-page clearfix a129ce20-ac44-11e0-afd5-782bcb32ff27">
      <div class="post not-page">
        <div class="photo"> <img src="/images/6FA058395455CDE17407FDA0FEC93F43_750_500.JPEG" width="500" height="333" alt="">
          <div class="icons"> <a class="high-res view" rel="a129ce20-ac44-11e0-afd5-782bcb32ff27" href="/images/6FA058395455CDE17407FDA0FEC93F43_750_500.JPEG"><span class="zoom">Zoom</span></a> </div>
        </div>
        <div class="rich-content">
          <p class="rich-content"></p>
          <p>望着窗外发呆</p>
          <p></p>
        </div>
      </div>
      <!-- close POST -->
      
      <aside>
        <p class="meta"> <a href="http://wefriends001.diandian.com/post/2011-07-12/2835286">Jul 12, 2011</a><br>
          <a href="http://wefriends001.diandian.com/post/2011-07-12/2835286#notes">0&nbsp;°C</a><br>
        </p>
      </aside>
      <footer>
        <div class="footer-meta">
         
        </div>
        <!-- close FOOTER-META --> 
      </footer>
    </article>
    
    <!--photo-->
    <article class="type-photoset not-page clearfix 7eb157a0-ac44-11e0-9113-782bcb3825eb">
      <div class="post not-page">
        <div class="photo"> <img src="/images/5CABB642FE0CA4C93322282DB2A4B304_500_750.JPEG" width="500" height="750" alt="">
          <div class="icons"> <a class="high-res view" rel="7eb157a0-ac44-11e0-9113-782bcb3825eb" href="/images/5CABB642FE0CA4C93322282DB2A4B304_500_750.JPEG"><span class="zoom">Zoom</span></a> </div>
        </div>
        <div class="rich-content">
          <p class="rich-content"></p>
          <p>泛黄的砖墙，掉漆的邮箱，都在述说着过往....却又存在于现在！也许是回忆过往，感慨现在！</p>
          <p></p>
        </div>
      </div>
      <!-- close POST -->
      <aside>
        <p class="meta"> <a href="http://wefriends001.diandian.com/post/2011-07-12/2835267">Jul 12, 2011</a><br>
          <a href="http://wefriends001.diandian.com/post/2011-07-12/2835267#notes">0&nbsp;°C</a><br>
        </p>
      </aside>
      <footer>
        <div class="footer-meta">
         
        </div>
        <!-- close FOOTER-META --> 
      </footer>
    </article>
  </section>
  <!-- close CONTENT -->
  
  <div id="pagination">
    <div class="next-prev">
      <div class="next"> <a href="http://wefriends001.diandian.com/page/2" title="浏览下一页">下一页</a> </div>
      <!-- End Next Page Button --> 
      
    </div>
    <div class="current-page"> Page 1 <span id="PageOf">of</span> 2 </div>
    <div class="pixel-union">
      <h5>Powered by hughnian</h5>
    </div>
  </div>
  <div id="sidebar_wrapper" style="height: 912px; top: 450px;">
    <section id="sidebar">
      <ul id="icons-nav">
        <% if(is_login){ %>
        <li class="profile"><a href="http://wefriends001.diandian.com/#">Profile</a></li>
        <% } %>
        <li class="pages"><a href="http://wefriends001.diandian.com/#">Pages</a></li>
      </ul>
      <div id="panels" style="height: 912px;">
        <div id="profile" class="box" style="height: 912px; overflow: hidden; padding: 0px; width: 299px;">
          <div class="jspContainer" style="width: 299px; height: 912px;">
            <div class="jspPane" style="padding: 40px 30px 100px; top: 0px; width: 239px;">
              <div id="me" class="me">
                <% if(userinfo){%>
                <img id="avatar" src="<%= userinfo.avatar%>" alt="<%= userinfo.name %>" style="min-width: 150px; min-height: 150px">
                <% } else {%>
                <img id="avatar" src="/images/EEA6ED71C1522729C18A55A9E3BDAE57_200_204.jpg" alt="TAKE360精品生活" style="min-width: 150px; min-height: 150px">
                <% } %>
              </div>
              <h2>关于我</h2>
              <p style="word-wrap: break-word; line-height: 18px; font-size: 12px">
                <% if(userinfo){ %>
                <%= userinfo.signature %>
                <% } %>
                </></p>
              <hr>
              <ul id="social-icons">
              </ul>
            </div>
          </div>
        </div>
        <!-- close PROFILE -->
        
        <div id="pages" class="box" style="height: 912px; overflow: hidden; padding: 0px; width: 299px;">
          <div class="jspContainer" style="width: 299px; height: 912px;">
            <div class="jspPane" style="padding: 40px 30px 100px; top: 0px; width: 239px;">
              <form id="searchForm" action="/images/TAKE360精品生活.htm" method="get">
                <input id="searchField" type="text" name="q" onBlur="if (this.value == &#39;&#39;) {this.value = &#39;搜索&#39;;}" onFocus="if (this.value == &#39;搜索&#39;) {this.value = &#39;&#39;;}" value="搜索">
              </form>
              <ul>
                <% if(!is_login){ %>
                <li><a href="/register">注册</a></li>
                <li><a href="/login">登录</a></li>
                <% } %>
                <li><a href="http://wefriends001.diandian.com/rss" title="RSS Feed">订阅</a></li>
                <li><a href="/logout" title="退出">退出</a></li>
              </ul>
            </div>
          </div>
        </div>
        <!-- close PAGES --> 
      </div>
      <!-- close PANELS --> 
    </section>
    <!-- close SIDEBAR --> 
  </div>
</div>
<!-- close WRAPPER -->
<footer id="footer"> </footer>
<!-- close FOOTER --> 
<script src="/js/plugins.js"></script>
<script src="/js/script2.js"></script>
<div id="fb-root"></div>
<script type="text/javascript">
    //建立websocket连接
    socket = io.connect('http://127.0.0.1:3000');
    
    user_msg = {};//全局用户聊天信息对象

    $(".sendbutton").click(function(){
      sendmsg();
    });
    
    $(".area").keydown(function(event){//兼容火狐浏览器需要传入event对象
       evt = event || window.event;//兼容ie6
       if(evt.keyCode==13){//按回车提交内容 如果加上 && event.ctrlKey 则crtl+enter提交
         sendmsg();
         evt.returnValue = false;//不换行
         return false;//不换行
       }
    });
    
    //发送消息
    function sendmsg()
    {
      var msg = $.trim($(".area").val());
      if(msg == ""){
          colorKit();
          return false;
      }
      $(".area").val("");
      var to = $(".chatname").html();
      socket.emit('message', {to:to,from:'<%= userinfo.name %>',msg:msg});
      if(typeof user_msg[to] === "undefined"){
         user_msg[to] = new Array({"to_msg":msg});
      } else {
         user_msg[to].push({"to_msg":msg});
      }
    }

    socket.on('message', function(data){
       if(typeof user_msg[data.from] == "undefined")
          user_msg[data.from] = new Array({"from_msg":data.msg});
       else
          user_msg[data.from].push({"from_msg":data.msg});
          var now_user = "<%= userinfo.name %>";
          delete user_msg[now_user];
       user_count = 0;
       msg_count = 0;
       var from_msg = [];
       if(typeof msg_count_old == "undefined")msg_count_old = 0;
       for(var key in user_msg){
           user_count++;
           for(var k in user_msg[key]){
              if(typeof user_msg[key][k].from_msg != "undefined")
               from_msg.push(user_msg[key][k].from_msg);
           }
       }
       msg_count = from_msg.length;
       if (data.to == "<%= userinfo.name %>" && $(".sendbox").css('display') == "none") {
          $(".chatbox").html("您有"+(msg_count-msg_count_old)+"消息");
          $(".chatbox").css("height",0).show().animate({"height":"25px"});
       } else if (data.to == "<%= userinfo.name %>" && $(".sendbox").css('display') == "block" && user_count > 1){
          showUserList();
       }

       if(data.from == "<%= userinfo.name%>"){
           var p = '<div class="chatdiv" id="chatdiv"><p class="p1">'+data.msg+'</p></div>';
       } else if(data.from == $(".chatname").html()){
           var p = '<div class="chatdiv" id="chatdiv"><p class="p2">'+data.msg+'</p><div>';
       }
       $(".sendlist").append(p);
       $('#sendlist').scrollTop($('#sendlist')[0].scrollHeight+$('#chatdiv').height()+50);//到scroll底部
    })
    
    socket.on('broadcast', function(msg){
       console.log('client get message'+msg);
       var p = '<div class="chatdiv" id="chatdiv"><p class="p2">'+msg+'</p><div>';
       $(".sendlist").append(p);
       $('#sendlist').scrollTop($('#sendlist')[0].scrollHeight+$('#chatdiv').height()+50);//到scroll底部
    })

    //聊天窗口控制
    $(".avatar").live('click', function(){
      $(".chatname").html($(this).attr('title'));
      $(".sendbox").css({'height':'0'}).show().animate({'height':'440px'});
    });
    
    //打开消息盒
    $(".chatbox").click(function(){
       msg_count_old = msg_count;
       $(this).hide();
       var p = [];
       if(user_count > 1){
         var userlist = [];
         var username = [];
         for(var key in user_msg){
             userlist.push("<span class='username' data-name="+key+">"+key+"<label class='deluser'>X</label></span>");
             username.push(key);
         }
         if($(".chatbox").html().match("您有")){
            var last_username = username[username.length-1];
            userlist[userlist.length-1] = "<span class='username' style='background:#E6DB74' data-name="+last_username+" id="+key+">"+last_username+"<label class='deluser'>X</label></span>";
            $(".userlist").html(userlist.join(""));
            for(var k in user_msg[last_username]){
            if(typeof user_msg[last_username][k].to_msg != "undefined")
              p.push('<div class="chatdiv" id="chatdiv"><p class="p1">'+user_msg[last_username][k].to_msg+'</p><div>');
            if(typeof user_msg[last_username][k].from_msg != "undefined")
              p.push('<div class="chatdiv" id="chatdiv"><p class="p2">'+user_msg[last_username][k].from_msg+'</p><div>');
            }
            $(".chatname").html(last_username);
         } else {
            var now_chat = $(".chatname").html();
            $(".userlist").html(userlist.join(""));
            $(".username").each(function(){
               if($(this).attr("data-name") == now_chat)
                 $(this).attr("style","background:#E6DB74");
            });
            for(var k in user_msg[now_chat]){
            if(typeof user_msg[now_chat][k].to_msg != "undefined")
              p.push('<div class="chatdiv" id="chatdiv"><p class="p1">'+user_msg[now_chat][k].to_msg+'</p><div>');
            if(typeof user_msg[now_chat][k].from_msg != "undefined")
              p.push('<div class="chatdiv" id="chatdiv"><p class="p2">'+user_msg[now_chat][k].from_msg+'</p><div>');
            }
            $(".chatname").html(now_chat);
         }
         
         $(".sendlist").html(p.join(""));
         $(".sendbox").css("display","block");
         $(".userlist").css({'height':'0'}).show().animate({'height':'440px'});
         $(".sendbox").css({'height':'0'}).show().animate({'height':'440px'});
       } else if (user_count == 1 || $(".chatbox").html().match("您有")){
         for(var key in user_msg){
            for(var k in user_msg[key]){
              if(typeof user_msg[key][k].to_msg != "undefined")
                p.push('<div class="chatdiv" id="chatdiv"><p class="p1">'+user_msg[key][k].to_msg+'</p><div>');
              if(typeof user_msg[key][k].from_msg != "undefined")
                p.push('<div class="chatdiv" id="chatdiv"><p class="p2">'+user_msg[key][k].from_msg+'</p><div>');
            }
            $(".chatname").html(key);
         }
         $(".sendlist").html(p.join(""));
         $(".sendbox").css("display","block");//使后面可以计算出 #sendlist的scrollTop    
       }
       $('#sendlist').scrollTop($('#sendlist')[0].scrollHeight+$('#chatdiv').height()+50);
       $(".sendbox").css({'height':'0'}).show().animate({'height':'440px'});
    });
    
    //读取多人的消息
    $(".username").live('click', function(){
      var name = $(this).attr("data-name");
      showUserMsg(name);
      $(".username").css("background","#FFF");
      $(this).css("background","#E6DB74");
    });
    
    
    $(".username").live('mouseover', function(){
      $(this).find(".deluser").show();
    });
    
    $(".username").live('mouseout', function(){
      $(this).find(".deluser").hide();
    });
    
    //删除某个聊天用户
    $(".deluser").live('click', function(event){
      evt = event || window.event;
      stopBubble(evt);//阻止事件冒泡
      $(this).parent().remove();
      var del_user = $(this).parent().attr("data-name");
      delete user_msg[del_user];
      user_count -= 1;
      var num = $(".username").length;
      if(num == 1) $(".userlist").hide();
      var username = $(".username").last().attr("data-name");
      showUserMsg(username);
    });

    function showUserMsg(name)
    {
      var p = [];
      for(var k in user_msg[name]){
          if(typeof user_msg[name][k].to_msg != "undefined")
            p.push('<div class="chatdiv" id="chatdiv"><p class="p1">'+user_msg[name][k].to_msg+'</p><div>');
          if(typeof user_msg[name][k].from_msg != "undefined")
            p.push('<div class="chatdiv" id="chatdiv"><p class="p2">'+user_msg[name][k].from_msg+'</p><div>');
      }
      $(".chatname").html(name);
      $(".sendlist").html(p.join(""));
      $(".sendbox").css("display","block");//使后面可以计算出 #sendlist的scrollTop 
      $('#sendlist').scrollTop($('#sendlist')[0].scrollHeight+$('#chatdiv').height()+50);
    }
    
    function showUserList()
    {
      var userlist = [];
       for(var key in user_msg){
           userlist.push("<span class='username' data-name="+key+">"+key+"<label class='deluser'>X</label></span>");
       }
       var now_chat = $(".chatname").html();
       $(".userlist").html(userlist.join(""));
       $(".username").each(function(){
          if($(this).attr("data-name") == now_chat)
            $(this).attr("style","background:#E6DB74");
       });
       $(".userlist").show();
    }

    $(".gb").click(function(){
       $(".sendbox").css({'height':'440px'}).hide().animate({'height':'0'});
       $(".userlist").css({'height':'440px'}).hide().animate({'height':'0'});
    });

    $(".zxh").click(function(){
       $(".sendbox").css({'height':'440px'}).hide().animate({'height':'0'});
       $(".userlist").css({'height':'440px'}).hide().animate({'height':'0'});       
       $(".chatbox").html($(".chatname").html());
       $(".chatbox").css({'height':'0'}).show().animate({'height':'25px'});
    });

    //输入框警告提示
    function colorOn()
    {
        $(".area").css("background","rgb(255, 211, 211)");
        Times++;
        window.setTimeout("colorOff()", 100);
    }

    function colorOff()
    {
        $(".area").css("background","#FFF");
        if(Times < 3) window.setTimeout("colorOn()", 100);
    }

    function colorKit()
    {
        Times = 0;
        window.setTimeout("colorOn()", 100);
    }
    
    //阻止事件冒泡
    function stopBubble(e){  
      if(document.attachEvent) {//ie  
          e.cancelBubble = true;  
      }else{  
          e.stopPropagation();  
      }  
    }
</script>
<% if(is_login){%>
<script type="text/javascript">
    $(function(){
        $.get("/friends?name=<%= userinfo.name %>", function(data){
              var img = [];
              for(var key in data){
                 img.push("<img src='"+data[key].avatar+"' title='"+data[key].name+"' alt='"+data[key].name+"' class='avatar'>");
              }
              $(".picside").html(img.join(""));
        });
    });
</script>
<% }%>
</body>
</html>
